<div class="users-container">
    <div class="header">
        <h1>User Management</h1>
        <p class="subtitle">Manage user approvals and roles</p>
    </div>

    <!-- Filters -->
    <div class="filters">
        <mat-form-field appearance="outline">
            <mat-label>Search Users</mat-label>
            <input matInput (keyup)="applyFilter($event)" placeholder="Name or Email" #input>
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Filter by Status</mat-label>
            <mat-select [(value)]="statusFilter" (selectionChange)="applyStatusFilter()">
                <mat-option value="All">All Status</mat-option>
                <mat-option value="Pending">Pending</mat-option>
                <mat-option value="Active">Active</mat-option>
                <mat-option value="Blocked">Blocked</mat-option>
            </mat-select>
        </mat-form-field>
    </div>

    <!-- Table -->
    <div class="mat-elevation-z8 table-container">
        <table mat-table [dataSource]="dataSource" matSort>

            <!-- Full Name Column -->
            <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
                <td mat-cell *matCellDef="let user"> {{user.fullName}} </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
                <td mat-cell *matCellDef="let user"> {{user.email}} </td>
            </ng-container>

            <!-- Requested Role Column -->
            <ng-container matColumnDef="requestedRole">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Requested Role </th>
                <td mat-cell *matCellDef="let user">
                    <mat-chip *ngIf="user.requestedRole" color="accent">
                        {{user.requestedRole}}
                    </mat-chip>
                    <span *ngIf="!user.requestedRole">-</span>
                </td>
            </ng-container>

            <!-- Current Role Column -->
            <ng-container matColumnDef="currentRole">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Current Role </th>
                <td mat-cell *matCellDef="let user">
                    <!-- IF status = ACTIVE: Show role as READ-ONLY CHIP -->
                    <mat-chip *ngIf="user.status === 'Active'"
                        [color]="user.currentRole === 'ADMIN' ? 'warn' : user.currentRole === 'INSTRUCTOR' ? 'accent' : 'primary'">
                        {{user.currentRole}}
                    </mat-chip>

                    <!-- IF status = PENDING: Show text "Pending" -->
                    <span *ngIf="user.status === 'Pending'">Pending</span>

                    <!-- IF status = BLOCKED or REJECTED: Show dash -->
                    <span *ngIf="user.status === 'Blocked' || user.status === 'Rejected'">-</span>
                </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                <td mat-cell *matCellDef="let user">
                    <mat-chip [color]="user.status === 'Active' ? 'primary' : user.status === 'Blocked' ? 'warn' : ''">
                        {{user.status}}
                    </mat-chip>
                    <div *ngIf="user.rejectionReason" class="rejection-reason">
                        <small>Reason: {{user.rejectionReason}}</small>
                    </div>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Actions </th>
                <td mat-cell *matCellDef="let user">
                    <!-- IF status = PENDING: Show Approve ✔ and Reject ✖ -->
                    <button mat-icon-button color="primary" (click)="approveUser(user)" matTooltip="Approve User"
                        *ngIf="user.status === 'Pending'">
                        <mat-icon>check_circle</mat-icon>
                    </button>

                    <button mat-icon-button color="warn" (click)="rejectUser(user)" matTooltip="Reject User"
                        *ngIf="user.status === 'Pending'">
                        <mat-icon>cancel</mat-icon>
                    </button>

                    <!-- IF status = ACTIVE and NOT ADMIN: Show Change Role and Block -->
                    <button mat-icon-button color="accent" (click)="changeUserRole(user)" matTooltip="Change Role"
                        *ngIf="user.status === 'Active' && user.currentRole !== 'ADMIN'">
                        <mat-icon>swap_horiz</mat-icon>
                    </button>

                    <button mat-icon-button color="warn" (click)="toggleBlockStatus(user)" matTooltip="Block User"
                        *ngIf="user.status === 'Active' && user.currentRole !== 'ADMIN'">
                        <mat-icon>block</mat-icon>
                    </button>

                    <!-- IF status = BLOCKED and NOT ADMIN: Show Unblock -->
                    <button mat-icon-button color="primary" (click)="toggleBlockStatus(user)" matTooltip="Unblock User"
                        *ngIf="user.status === 'Blocked' && user.currentRole !== 'ADMIN'">
                        <mat-icon>lock_open</mat-icon>
                    </button>

                    <!-- IF user role = ADMIN: Hide ALL actions (no buttons shown) -->
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="6">No users found matching "{{input.value}}"</td>
            </tr>
        </table>

        <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" aria-label="Select page of users"></mat-paginator>
    </div>
</div>